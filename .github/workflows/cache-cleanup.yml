name: ç¼“å­˜æ¸…ç†

on:
  schedule:
    # æ¯å‘¨æ¸…ç†ä¸€æ¬¡ç¼“å­˜
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  actions: write

jobs:
  cleanup-cache:
    name: æ¸…ç†è¿‡æœŸç¼“å­˜
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ§¹ æ¸…ç†GitHub Actionsç¼“å­˜
      continue-on-error: true
      uses: actions/github-script@v6
      with:
        script: |
          try {
            console.log("ğŸ§¹ å¼€å§‹æ¸…ç†è¿‡æœŸç¼“å­˜...");

            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            let deletedCount = 0;

            for (const cache of caches.data.actions_caches) {
              const cacheDate = new Date(cache.created_at);

              if (cacheDate < oneWeekAgo) {
                console.log(`åˆ é™¤è¿‡æœŸç¼“å­˜: ${cache.key} (åˆ›å»ºäº: ${cache.created_at})`);

                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    cache_id: cache.id,
                  });
                  deletedCount++;
                } catch (error) {
                  console.log(`åˆ é™¤ç¼“å­˜å¤±è´¥: ${error.message}`);
                }
              }
            }

            console.log(`âœ… æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ ${deletedCount} ä¸ªè¿‡æœŸç¼“å­˜`);
          } catch (error) {
            console.log(`âš ï¸ ç¼“å­˜æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
            console.log("ä½†å·¥ä½œæµå°†ç»§ç»­æ‰§è¡Œ");
          }

    - name: ğŸ“Š ç¼“å­˜ç»Ÿè®¡
      continue-on-error: true
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            console.log("ğŸ“Š å½“å‰ç¼“å­˜ç»Ÿè®¡:");
            console.log(`- æ€»ç¼“å­˜æ•°é‡: ${caches.data.total_count}`);

            let totalSize = 0;
            const cacheTypes = {};

            for (const cache of caches.data.actions_caches) {
              totalSize += cache.size_in_bytes;

              const keyPrefix = cache.key.split('-')[0];
              cacheTypes[keyPrefix] = (cacheTypes[keyPrefix] || 0) + 1;
            }

            console.log(`- æ€»ç¼“å­˜å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
            console.log("- ç¼“å­˜ç±»å‹åˆ†å¸ƒ:");

            for (const [type, count] of Object.entries(cacheTypes)) {
              console.log(`  - ${type}: ${count} ä¸ª`);
            }
          } catch (error) {
            console.log(`âš ï¸ ç¼“å­˜ç»Ÿè®¡è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
            console.log("ä½†å·¥ä½œæµå°†ç»§ç»­æ‰§è¡Œ");
          }
