name: å¾®ä¿¡è¯»ä¹¦è‡ªåŠ¨é˜…è¯»

on:
  schedule:
    # å‡Œæ™¨ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 01:00ï¼ˆUTC å‰ä¸€å¤© 17:00ï¼‰
    - cron: '0 17 * * *'
    # æ—©é—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 05:00ï¼ˆUTC å‰ä¸€å¤© 21:00ï¼‰
    #- cron: '0 21 * * *'
    # åˆé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 11:40ï¼ˆUTC 03:40ï¼‰
    #- cron: '40 3 * * *'
    # æ™šé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 22:00ï¼ˆUTC 14:00ï¼‰
    #- cron: '0 14 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      read_minutes:
        description: 'é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '30'
        type: choice
        options:
          - '20'
          - '30'
          - '40'
          - '50'
          - '60'
      log_level:
        description: 'æ—¥å¿—çº§åˆ«'
        required: false
        default: 'INFO'
        type: choice
        options:
          - 'DEBUG'
          - 'INFO'
          - 'WARNING'
          - 'ERROR'
      use_legacy:
        description: 'ä½¿ç”¨æ—§ç‰ˆæœ¬é€»è¾‘'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: read
  actions: read

jobs:
  wxread:
    name: å¾®ä¿¡è¯»ä¹¦è‡ªåŠ¨é˜…è¯»
    runs-on: ubuntu-latest
    environment: AutoRead
    timeout-minutes: 120  # è®¾ç½®è¶…æ—¶æ—¶é—´

    # å¹¶å‘æ§åˆ¶
    concurrency:
      group: wxread-${{ github.ref }}
      cancel-in-progress: false

    steps:
    - name: ğŸš€ å¼€å§‹ä»»åŠ¡
      run: |
        echo "::notice title=ä»»åŠ¡å¼€å§‹::å¾®ä¿¡è¯»ä¹¦è‡ªåŠ¨é˜…è¯»ä»»åŠ¡å¼€å§‹æ‰§è¡Œ"
        echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ–¥ï¸  è¿è¡Œç¯å¢ƒ: ${{ runner.os }} ${{ runner.arch }}"

    - name: ğŸŒ é…ç½®ç½‘ç»œç¯å¢ƒ
      continue-on-error: true
      run: |
        echo "ğŸ”§ é…ç½®DNSæœåŠ¡å™¨..."
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf || echo "âš ï¸ DNSé…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf || true
        echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf || true

        echo "ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥..."
        if ping -c 3 weread.qq.com; then
          echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸"
        else
          echo "âš ï¸ å¾®ä¿¡è¯»ä¹¦æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        fi

    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # æµ…å…‹éš†ä»¥æé«˜é€Ÿåº¦

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # å¯ç”¨pipç¼“å­˜

    - name: ğŸ“¦ ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      continue-on-error: true
      with:
        path: |
          ~/.cache/pip
          ~/.local/lib/python3.11/site-packages
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ² ç”Ÿæˆé˜…è¯»å‚æ•°
      id: reading_params
      run: |
        # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„å‚æ•°ï¼Œå¦åˆ™ç”Ÿæˆéšæœºå€¼
        if [ "${{ github.event.inputs.read_minutes }}" != "" ]; then
          MINUTES=${{ github.event.inputs.read_minutes }}
          READ_NUM=$((MINUTES * 2))
          echo "ğŸ“ ä½¿ç”¨æ‰‹åŠ¨è®¾ç½®: ${MINUTES}åˆ†é’Ÿ (${READ_NUM}æ¬¡)"
        else
          # ç”Ÿæˆ30-60åˆ†é’Ÿå¯¹åº”çš„éšæœºæ¬¡æ•°ï¼ˆ60-120æ¬¡ï¼‰
          READ_NUM=$((RANDOM % 61 + 60))
          MINUTES=$((READ_NUM / 2))
          echo "ğŸ² éšæœºç”Ÿæˆ: ${MINUTES}åˆ†é’Ÿ (${READ_NUM}æ¬¡)"
        fi

        echo "READ_NUM=$READ_NUM" >> $GITHUB_OUTPUT
        echo "MINUTES=$MINUTES" >> $GITHUB_OUTPUT
        echo "::notice title=é˜…è¯»å‚æ•°::é¢„è®¡é˜…è¯»æ—¶é•¿ ${MINUTES} åˆ†é’Ÿ"

    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: |
        echo "ğŸ“¦ å‡çº§pip..."
        python -m pip install --upgrade pip setuptools wheel || echo "âš ï¸ pipå‡çº§å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ç‰ˆæœ¬"

        echo "ğŸ“‹ å®‰è£…é¡¹ç›®ä¾èµ–..."
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt || {
            echo "âš ï¸ requirements.txtå®‰è£…å¤±è´¥ï¼Œå°è¯•åŸºç¡€ä¾èµ–"
            pip install requests>=2.32.3 urllib3>=2.2.3 || echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
          }
        else
          # å…¼å®¹æ—§ç‰ˆæœ¬çš„ä¾èµ–å®‰è£…
          pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3 || {
            echo "âš ï¸ æŒ‡å®šç‰ˆæœ¬å®‰è£…å¤±è´¥ï¼Œå°è¯•æœ€æ–°ç‰ˆæœ¬"
            pip install requests urllib3 certifi charset-normalizer idna || echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
          }
        fi

        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        pip list || echo "âš ï¸ æ— æ³•åˆ—å‡ºå·²å®‰è£…åŒ…"

    - name: ğŸ” ç¯å¢ƒæ£€æŸ¥
      continue-on-error: true
      run: |
        echo "ğŸ” æ£€æŸ¥Pythonç¯å¢ƒ..."
        python --version || echo "âš ï¸ æ— æ³•è·å–Pythonç‰ˆæœ¬"
        pip --version || echo "âš ï¸ æ— æ³•è·å–pipç‰ˆæœ¬"

        echo "ğŸ“ æ£€æŸ¥é¡¹ç›®æ–‡ä»¶..."
        ls -la || echo "âš ï¸ æ— æ³•åˆ—å‡ºæ–‡ä»¶"

        echo "ğŸ§ª æµ‹è¯•æ¨¡å—å¯¼å…¥..."
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from src.utils.exceptions import WxReadError
            print('âœ… æ–°ç‰ˆæœ¬æ¨¡å—å¯ç”¨')
        except ImportError:
            print('âš ï¸ æ–°ç‰ˆæœ¬æ¨¡å—ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨å…¼å®¹æ¨¡å¼')
        except Exception as e:
            print(f'âš ï¸ æ¨¡å—æµ‹è¯•å¼‚å¸¸: {e}')
        " || echo "âš ï¸ æ¨¡å—å¯¼å…¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: ğŸ“š æ‰§è¡Œé˜…è¯»ä»»åŠ¡
      id: reading_task
      continue-on-error: true
      env:
        # å¾®ä¿¡è¯»ä¹¦é…ç½®
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        READ_NUM: ${{ steps.reading_params.outputs.READ_NUM }}

        # æ¨é€é…ç½®
        PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

        # ç½‘ç»œä»£ç†ï¼ˆå¯é€‰ï¼‰
        http_proxy: ${{ secrets.HTTP_PROXY }}
        https_proxy: ${{ secrets.HTTPS_PROXY }}

        # æ—¥å¿—é…ç½®
        LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}

      run: |
        echo "ğŸ“š å¼€å§‹æ‰§è¡Œå¾®ä¿¡è¯»ä¹¦ä»»åŠ¡..."
        echo "â±ï¸  é¢„è®¡é˜…è¯»æ—¶é•¿: ${{ steps.reading_params.outputs.MINUTES }}åˆ†é’Ÿ"
        echo "ğŸ”§ æ—¥å¿—çº§åˆ«: ${LOG_LEVEL}"

        # æ£€æŸ¥å¿…è¦çš„é…ç½®
        if [ -z "$WXREAD_CURL_BASH" ]; then
          echo "âš ï¸ WXREAD_CURL_BASHæœªé…ç½®ï¼Œä»»åŠ¡å¯èƒ½å¤±è´¥"
        fi

        # é€‰æ‹©æ‰§è¡Œæ¨¡å¼å¹¶æ·»åŠ é‡è¯•æœºåˆ¶
        RETRY_COUNT=0
        MAX_RETRIES=2

        while [ $RETRY_COUNT -le $MAX_RETRIES ]; do
          echo "ğŸ”„ å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡æ‰§è¡Œ..."

          if [ "${{ github.event.inputs.use_legacy }}" = "true" ]; then
            echo "ğŸ”„ ä½¿ç”¨æ—§ç‰ˆæœ¬é€»è¾‘..."
            if python main.py --legacy; then
              echo "âœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
              break
            fi
          else
            echo "ğŸš€ ä½¿ç”¨æ–°ç‰ˆæœ¬é€»è¾‘..."
            if python main.py --log-level "${LOG_LEVEL}"; then
              echo "âœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
              break
            fi
          fi

          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -le $MAX_RETRIES ]; then
            echo "âš ï¸ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œ30ç§’åé‡è¯•..."
            sleep 30
          else
            echo "âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
            exit 0  # ä¸è®©æ•´ä¸ªå·¥ä½œæµå¤±è´¥
          fi
        done

    - name: ğŸ“Š ä»»åŠ¡ç»“æœ
      if: always()
      run: |
        if [ "${{ steps.reading_task.outcome }}" = "success" ]; then
          echo "::notice title=ä»»åŠ¡å®Œæˆ::âœ… å¾®ä¿¡è¯»ä¹¦ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        else
          echo "::error title=ä»»åŠ¡å¤±è´¥::âŒ å¾®ä¿¡è¯»ä¹¦ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        fi

        echo "ğŸ“ˆ ä»»åŠ¡ç»Ÿè®¡:"
        echo "- æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "- ç›®æ ‡æ—¶é•¿: ${{ steps.reading_params.outputs.MINUTES }}åˆ†é’Ÿ"
        echo "- ä»»åŠ¡çŠ¶æ€: ${{ steps.reading_task.outcome }}"

    - name: ğŸ§¹ æ¸…ç†ç¼“å­˜
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf logs/*.log 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"
