name: wxread

on:
  schedule:
    # å‡Œæ™¨ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 01:00ï¼ˆUTC å‰ä¸€å¤© 17:00ï¼‰
    - cron: '0 17 * * *'
    # æ—©é—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 05:00ï¼ˆUTC å‰ä¸€å¤© 21:00ï¼‰
    #- cron: '0 21 * * *'
    # åˆé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 11:40ï¼ˆUTC 03:40ï¼‰
    #- cron: '40 3 * * *'
    # æ™šé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 22:00ï¼ˆUTC 14:00ï¼‰
    #- cron: '0 14 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead  # æŒ‡å®šç¯å¢ƒ

    steps:

    - name: Set DNS to Google's DNS
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Generate random READ_NUM
      id: random_read_num
      run: |
        # ç”Ÿæˆ30-60åˆ†é’Ÿå¯¹åº”çš„éšæœºæ¬¡æ•°ï¼ˆ60-120æ¬¡ï¼‰
        # æ¯æ¬¡30ç§’ï¼Œ30åˆ†é’Ÿ=60æ¬¡ï¼Œ60åˆ†é’Ÿ=120æ¬¡
        RANDOM_READ_NUM=$((RANDOM % 61 + 60))
        RANDOM_MINUTES=$((RANDOM_READ_NUM / 2))
        echo "READ_NUM=$RANDOM_READ_NUM" >> $GITHUB_OUTPUT
        echo "MINUTES=$RANDOM_MINUTES" >> $GITHUB_OUTPUT
        echo "ğŸ² éšæœºç”Ÿæˆé˜…è¯»æ—¶é•¿: ${RANDOM_MINUTES}åˆ†é’Ÿ (${RANDOM_READ_NUM}æ¬¡)"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3

    - name: Run deployment script
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        READ_NUM: ${{ steps.random_read_num.outputs.READ_NUM }}  # ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„éšæœºå€¼

      run: |
        echo "ğŸ“š å¼€å§‹æ‰§è¡Œå¾®ä¿¡è¯»ä¹¦ä»»åŠ¡ï¼Œé¢„è®¡é˜…è¯»æ—¶é•¿: ${{ steps.random_read_num.outputs.MINUTES }}åˆ†é’Ÿ"
        python main.py
