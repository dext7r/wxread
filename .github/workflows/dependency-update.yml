name: ä¾èµ–æ›´æ–°æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: æ£€æŸ¥å¹¶æ›´æ–°ä¾èµ–
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£…pip-tools
      continue-on-error: true
      run: |
        python -m pip install --upgrade pip || echo "âš ï¸ pipå‡çº§å¤±è´¥"
        pip install pip-tools || echo "âš ï¸ pip-toolså®‰è£…å¤±è´¥"

    - name: ğŸ” æ£€æŸ¥ä¾èµ–æ›´æ–°
      id: check_updates
      continue-on-error: true
      run: |
        echo "ğŸ” æ£€æŸ¥ä¾èµ–æ›´æ–°..."

        # å¤‡ä»½å½“å‰requirements.txt
        cp requirements.txt requirements.txt.backup || {
          echo "âš ï¸ æ— æ³•å¤‡ä»½requirements.txt"
          echo "HAS_UPDATES=false" >> $GITHUB_OUTPUT
          exit 0
        }

        # ç”Ÿæˆæ–°çš„requirements.txt
        if [ -f "requirements.in" ]; then
          pip-compile --upgrade requirements.in 2>/dev/null || {
            echo "âš ï¸ pip-compileå¤±è´¥ï¼Œè·³è¿‡ä¾èµ–æ›´æ–°æ£€æŸ¥"
            echo "HAS_UPDATES=false" >> $GITHUB_OUTPUT
            exit 0
          }
        else
          echo "âš ï¸ requirements.inä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–æ›´æ–°æ£€æŸ¥"
          echo "HAS_UPDATES=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if ! diff -q requirements.txt requirements.txt.backup > /dev/null 2>&1; then
          echo "HAS_UPDATES=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å‘ç°ä¾èµ–æ›´æ–°:"
          diff requirements.txt.backup requirements.txt || true
        else
          echo "HAS_UPDATES=false" >> $GITHUB_OUTPUT
          echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
        fi

    - name: ğŸ§ª æµ‹è¯•æ›´æ–°åçš„ä¾èµ–
      if: steps.check_updates.outputs.HAS_UPDATES == 'true'
      continue-on-error: true
      run: |
        echo "ğŸ§ª æµ‹è¯•æ›´æ–°åçš„ä¾èµ–..."

        # å®‰è£…æ–°ä¾èµ–
        pip install -r requirements.txt || {
          echo "âš ï¸ æ–°ä¾èµ–å®‰è£…å¤±è´¥ï¼Œæ¢å¤åŸä¾èµ–"
          pip install -r requirements.txt.backup || echo "âŒ ä¾èµ–æ¢å¤å¤±è´¥"
          exit 0
        }

        # æµ‹è¯•æ¨¡å—å¯¼å…¥
        python -c "
        import sys
        sys.path.insert(0, 'src')

        try:
            from src.utils.exceptions import WxReadError
            from src.config.manager import ConfigManager
            from src.notifications.manager import NotificationManager
            print('âœ… ä¾èµ–æ›´æ–°æµ‹è¯•é€šè¿‡')
        except ImportError as e:
            print(f'âš ï¸ ä¾èµ–æ›´æ–°æµ‹è¯•å¤±è´¥: {e}ï¼Œä½†ç»§ç»­æ‰§è¡Œ')
        except Exception as e:
            print(f'âš ï¸ ä¾èµ–æµ‹è¯•å¼‚å¸¸: {e}ï¼Œä½†ç»§ç»­æ‰§è¡Œ')
        " || echo "âš ï¸ ä¾èµ–æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: ğŸ“ ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
      if: steps.check_updates.outputs.HAS_UPDATES == 'true'
      run: |
        echo "ğŸ“ ç”Ÿæˆä¾èµ–æ›´æ–°æŠ¥å‘Š..."
        
        cat > dependency-update-report.md << 'EOF'
        # ä¾èµ–æ›´æ–°æŠ¥å‘Š
        
        ## ğŸ“¦ æ›´æ–°çš„ä¾èµ–åŒ…
        
        ```diff
        EOF
        
        diff requirements.txt.backup requirements.txt >> dependency-update-report.md || true
        
        cat >> dependency-update-report.md << 'EOF'
        ```
        
        ## âœ… æµ‹è¯•ç»“æœ
        
        - [x] æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡
        - [x] åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡
        
        ## ğŸ”§ å»ºè®®æ“ä½œ
        
        1. å®¡æŸ¥æ›´æ–°çš„ä¾èµ–åŒ…
        2. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
        3. åˆå¹¶æ­¤PRä»¥åº”ç”¨æ›´æ–°
        
        ---
        
        *æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–å·¥å…·ç”Ÿæˆ*
        EOF

    - name: ğŸ”€ åˆ›å»ºPull Request
      if: steps.check_updates.outputs.HAS_UPDATES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'ğŸ“¦ è‡ªåŠ¨æ›´æ–°ä¾èµ–åŒ…'
        title: 'ğŸ“¦ ä¾èµ–åŒ…è‡ªåŠ¨æ›´æ–°'
        body-path: dependency-update-report.md
        branch: dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated

    - name: ğŸ“¢ æ›´æ–°é€šçŸ¥
      if: always()
      run: |
        if [ "${{ steps.check_updates.outputs.HAS_UPDATES }}" = "true" ]; then
          echo "::notice title=ä¾èµ–æ›´æ–°::ğŸ“¦ å‘ç°ä¾èµ–æ›´æ–°ï¼Œå·²åˆ›å»ºPR"
        else
          echo "::notice title=ä¾èµ–æ£€æŸ¥::âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
        fi
